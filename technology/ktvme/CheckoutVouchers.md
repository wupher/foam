# 开台单优化方案草案

## 开台单定义

- 业务定义： KTV 客人在商家中一次独立的消费总计
- 数据定义： 商户通对同一营业日的账单按开台单号进行归并，合并后形成开台单

## 应用场景

商户通：

- 包厢账单
- 员工业绩（非赢娱）

服务员点单：

- 员工业绩

SOP:

- 运营发券效果评估

## 现有问题

当开台单横跨多个营业日时，线上按单日合成的开台单会有偏差。假设用户从 1 号来到 KTV 一直到 3 号才消费结束。期间每天都有消费单。

通娱会将账单账期与开台单账期分开。通娱系统中，开台单按营业日查询，归属于 1 号。但在上传账单时，会按实际发生日，将中间结账的单子按 2 号，3 号分别上传。

商户通按营业日报与管理系统对账时，由于统一按账单账期维度计算，因此是一致的。（确实于当日发生该笔交易）

但在开台单对账时，由于账单横跨多个营业日，合并时会导致数据与线下不一致。另外，由于包厢单往往最后结账，导致整个开台单账单会归属于第 3 天，而不是第 1 天。此点也与线下不一致。

与之相关的指标是待客批次。由于包厢单按最终结账日上传，线上与线下的待客批次会在此点存在不一致，但三天之合是相同的。

此外，部分旧版本管理系统有时会出现上传的超市单即使有包厢信息和客人信息，但没有开台单号的现象。

## 优化方案

管理系统提供开台单查询接口：以营业日为参数，返回隶属于当日的开台单列表。对于每个开单号，都列出其下归属的账单号。

商户通在计算开单时可使用此接口，通过对于账单号进行归并，分析，可以根据账单号中的“营业日”命名规则，计算出总计需要加载多少天的账单来参与计算。

根据“开台单 - 账单”隶属关系，直接使用账单进行归并而不限于开台单号，即可避免前述两项问题。

### Pros & Cons

Pros:

- 不再限于单营业日账单和开台单号，避免了当前生成开台单的两个问题
- 加载账单以最小原则，甚至可以根据计算出的归属营业日区间重新向线下再获取账单

Cons：

- 计算较为复杂，如果要从线下重新获取账单还牵涉多日账单捞取，较之前更费时
- 由于计算复杂，耗时较长，因此不适于实时开台单计算（可能影响数据及时刷新，建议实际压测后评估）
- 开台单归属日期仍然与账单账期不一致，使用此方法生成开台单后，有可能当日开台单相加后金额大于账单金额（跨营业日导致）。
- 与上条类似，当日待客批次也与开台单数不一致

## 结论

建议使用此方案先用于后台修复跨营业日导致的开台单数据不一致情况。日报计算和开台单计算仍然使用之前方式。

后续生产验证后，再考虑添加自动检测，自动生成功能: 当检测当日账单中存在不属于今日的包厢账单（跨营业日）再自动化调用接口重新生成当日开台单, 此项处理即可全部转为自动化执行。
