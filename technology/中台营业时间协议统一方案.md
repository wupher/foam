# 中台营业时间统一协议方案

## 结论

在线超市，微加预订系统统一使用商户通协议作为管理系统营业时间同步协议。原有的相关超市及预订系统营业时间协议被废弃。

### 原因

- 预订及超市的协议均为内部使用，商户通营业时间协议除自用外，平台及厦研也有使用，变更影响面更大。
- 超市及预订协议的内容仅有商家营业时间设置，商户通协议已包含相关数据。可以兼容超市及预订使用。
- 除营业时间外，商户通协议还包含诸如管理系统版本，网关信息等，客服及相关业务有使用这些信息。

## 接入

### Kafka 接入

统一使用 Kafka 进行数据接入，超市和预订都已接入商户通房态流，只需订阅 [Topic: `companyOpenTime`] 即可接收。

数据格式为 JSON，示例如下：

```JSON
{
  "companyId": "1",
    "data": {
    "system": "精通Version-标准版-3.6.20220113[]",
    "version_num": 20220113,
    "open_time": "10:00:00",
    "close_time": "10:00:00",
    "gateway": 1
  }
}
```

字段说明：

| 字段名称 | 类型 | 说明 |
| --- | --- | --- |
| system | string | 系统版本号 |
| version_num | int | 版本号 |
| open_time | string | 营业开始时间 |
| close_time | string | 营业结束时间 |
| gateway | int | 网关类型 0-软件网关 1-物理网关 |

每次管理系统开机或更新营业时间，都会触发此信息上报。

### MQ 查询

除主动上报外，也支持使用 MQ 协议进行查询，主动更新线下系统设置信息。

MQ 请求:

```JSON
{
  "companycode": "08204",
  "cmdid": "WJ091",
  "type": "0"
}
```

MQ 返回数据

```JSON
{
  "ret": 0,
  "msg": "",
  "data": {
    "system": "精通Version-标准版-3.6.20220113[]",
    "version_num": 20220113,
    "open_time": "10:00:00",
    "close_time": "10:00:00",
    "gateway": 1
  },
  "cmdid": "WJ091"
}
```
